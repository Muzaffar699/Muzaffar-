<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUZAFFAR Paint</title>
    <style>
        :root {
            --primary-color: #0078d7;
            --toolbar-bg: #f3f3f3;
            --toolbar-border: #d0d0d0;
            --button-hover: #e5f3ff;
            --button-active: #cce8ff;
            --canvas-bg: #d0d0d0;
            --status-bar-bg: #0078d7;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .title-bar {
            background-color: var(--primary-color);
            color: white;
            padding: 5px 10px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-app-region: drag;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-icon {
            width: 16px;
            height: 16px;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .toolbar {
            background-color: var(--toolbar-bg);
            border-right: 1px solid var(--toolbar-border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            width: 70px;
            gap: 5px;
            align-items: center;
        }

        .tool-group {
            width: 100%;
            margin-bottom: 15px;
        }

        .tool-group-title {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            text-align: center;
        }

        .tool-btn {
            background-color: transparent;
            border: 1px solid transparent;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 100%;
            margin-bottom: 2px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background-color: var(--button-hover);
            border-color: #b1d9f8;
        }

        .tool-btn.active {
            background-color: var(--button-active);
            border-color: #7cb9f0;
        }

        .tool-icon {
            width: 20px;
            height: 20px;
        }

        .tool-name {
            font-size: 10px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            width: 100%;
            margin-top: 10px;
        }

        .color-swatch {
            width: 25px;
            height: 25px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
        }

        .color-swatch.active {
            border: 2px solid #000;
        }

        .color-picker-container {
            width: 100%;
            margin-top: 10px;
        }

        .color-picker {
            width: 100%;
            height: 30px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .size-selector-container {
            width: 100%;
            margin-top: 10px;
        }

        .size-selector {
            width: 100%;
            margin-top: 5px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .top-toolbar {
            background-color: var(--toolbar-bg);
            border-bottom: 1px solid var(--toolbar-border);
            padding: 5px 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .top-tool-btn {
            background-color: transparent;
            border: 1px solid transparent;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .top-tool-btn:hover {
            background-color: var(--button-hover);
            border-color: #b1d9f8;
        }

        .canvas-container {
            flex: 1;
            overflow: auto;
            background-color: var(--canvas-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #paintCanvas {
            background-color: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            cursor: crosshair;
        }

        .status-bar {
            background-color: var(--status-bar-bg);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
        }

        .shape-options {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: 10px;
        }

        .shape-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }

        .shape-select {
            padding: 3px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="title-bar">
        <div class="app-title">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0id2hpdGUiIGQ9Ik0yMC43MSw3LjA0QzIxLjEsNi42NSAyMS4xLDYuMDQgMjAuNzEsNS42M0wxOC4zNywzLjI5QzE3Ljk4LDIuOSAxNy4zNSwyLjkgMTYuOTYsMy4yOUwxNS4wOCw1LjE3TDE4LjgzLDguOTJMMjAuNzEsNy4wNE0zLjE3LDE3LjI1VjIxSDcuMDhMMTguMjMsOS44N0wxNC41LDYuMTNMMy4xNywxNy4yNVoiIC8+PC9zdmc+" class="app-icon">
            <span>MUZAFFAR Paint</span>
        </div>
        <div>
            <span id="document-name">Untitled</span>
        </div>
    </div>

    <div class="main-container">
        <div class="toolbar">
            <div class="tool-group">
                <div class="tool-group-title">Tools</div>
                <button class="tool-btn active" id="pencilTool" title="Pencil (P)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTIwLjcxLDcuMDRDMjEuMSw2LjY1IDIxLjEsNi4wNCAyMC43MSw1LjYzTDE4LjM3LDMuMjdDMTcuOTgsMi44OCAxNy4zNSwyLjg4IDE2Ljk2LDMuMjdMMTUuMDgsNS4xNUwxOC44Myw4LjkyTDIwLjcxLDcuMDRNMy4xNywxNy4yNVYyMUg3LjA4TDE4LjIzLDkuODdMMTQuNSw2LjEzTDMuMTcsMTcuMjVaIiAvPjwvc3ZnPg==" class="tool-icon">
                    <span class="tool-name">Pencil</span>
                </button>
                <button class="tool-btn" id="brushTool" title="Brush (B)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTIwLjcxLDQuMDRDMjEuMSwzLjY1IDIxLjEsMy4wNCAyMC43MSwyLjYzTDE5LjM3LDEuMjdDMTguOTgsMC44OCAxOC4zNSwwLjg4IDE3Ljk2LDEuMjdMOSw5LjI1TDE0Ljc1LDE1TDIyLjcxLDYuMDRDMjMuMSw1LjY1IDIzLjEsNS4wNCAyMi43MSw0LjYzTDIwLjcxLDQuMDRNMy4xNywxOC4yNVYyMkg3LjA4TDE1LjIzLDEzLjg3TDkuNSw4LjEzTDMuMTcsMTQuNDZMMy4xNywxOC4yNVoiIC8+PC9zdmc+" class="tool-icon">
                    <span class="tool-name">Brush</span>
                </button>
                <button class="tool-btn" id="eraserTool" title="Eraser (E)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTE2LjI0LDNINS43NkM1LjM1LDMsNSwzLjM1LDUsMy43NnYxNi40N0M1LDUuMTEsNSw1LjQ2LDUuMjQsNS43Nmw3LjU4LDcuNThjMS4wNiwxLjA2LDIuNzgsMS4wNiwzLjg0LDBsNS43NS01Ljc1YzEuMDYtMS4wNiwxLjA2LTIuNzgsMC0zLjg0TDE2LjI0LDNNMTQuODMsMTYuNDFMNy40Miw5LjE3bDEuNDEtMS40MWw3LjQxLDcuMjRMMTQuODMsMTYuNDFaIiAvPjwvc3ZnPg==" class="tool-icon">
                    <span class="tool-name">Eraser</span>
                </button>
                <button class="tool-btn" id="fillTool" title="Fill (F)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTE5LDExSDE3VjlDMTcsNy44OSAxNi4xMSw3IDE1LDdIMTNWNUMxMywzLjg5IDEyLjExLDMgMTEsM0g0QzIuOSwzIDIsMy45IDIsNVYxOUMyLDIwLjExIDIuOSwyMSA0LDIxSDEzQzE0LjExLDIxIDE1LDIwLjExIDE1LDE5VjE3SDE4QzE5LjExLDE3IDIwLDE2LjExIDIwLDE1VjEzQzIwLDExLjg5IDE5LjExLDExIDE5LDExTTgsNUg4VjdIOFY1TTgsOUg4VjExSDhWOU04LDEzSDhWMTVIOFYxM00xNCwxOUg0VjVIOFY5SDEyVjEzSDE2VjE1SDE0VjE5WiIgLz48L3N2Zz4=" class="tool-icon">
                    <span class="tool-name">Fill</span>
                </button>
            </div>

            <div class="tool-group">
                <div class="tool-group-title">Shapes</div>
                <button class="tool-btn" id="lineTool" title="Line (L)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTE5LDEzSDVWMTFIMTlWMTNaIiAvPjwvc3ZnPg==" class="tool-icon">
                    <span class="tool-name">Line</span>
                </button>
                <button class="tool-btn" id="rectTool" title="Rectangle (R)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTIsNEgyMlYxOUgyVjRNNCw2VjE3SDIwVjZINFoiIC8+PC9zdmc+" class="tool-icon">
                    <span class="tool-name">Rectangle</span>
                </button>
                <button class="tool-btn" id="circleTool" title="Circle (C)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTEyLDJBMTAsMTAgMCAwLDAgMiwxMkExMCwxMCAwIDAsMCAxMiwyMkExMCwxMCAwIDAsMCAyMiwxMkExMCwxMCAwIDAsMCAxMiwyTTEyLDRBOCw4IDAgMCwxIDIwLDEyQTgsOCAwIDAsMSAxMiwyMEE4LDggMCAwLDEgNCwxMkE4LDggMCAwLDEgMTIsNCIgLz48L3N2Zz4=" class="tool-icon">
                    <span class="tool-name">Circle</span>
                </button>
                <button class="tool-btn" id="triangleTool" title="Triangle (T)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTEyLDJMMiwyMkgyMkwxMiwyWiIgLz48L3N2Zz4=" class="tool-icon">
                    <span class="tool-name">Triangle</span>
                </button>
                <button class="tool-btn" id="polygonTool" title="Polygon (Y)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTEyLDEuOTJMMTcuMzUsNi43N0wxNS41NiwxMy4wN0g4LjQ0TDYuNjUsNi43N0wxMiwxLjkyTTEyLDBMMTAsMkwyLDJMMTAsMTJMMTAsMjJMMTQsMjJMMTQsMTJMMjIsMkwxNCwyTDEyLDBaIiAvPjwvc3ZnPg==" class="tool-icon">
                    <span class="tool-name">Polygon</span>
                </button>
            </div>

            <div class="tool-group">
                <div class="tool-group-title">Colors</div>
                <div class="color-palette">
                    <div class="color-swatch active" style="background-color: #000000;" data-color="#000000"></div>
                    <div class="color-swatch" style="background-color: #ff0000;" data-color="#ff0000"></div>
                    <div class="color-swatch" style="background-color: #00ff00;" data-color="#00ff00"></div>
                    <div class="color-swatch" style="background-color: #0000ff;" data-color="#0000ff"></div>
                    <div class="color-swatch" style="background-color: #ffff00;" data-color="#ffff00"></div>
                    <div class="color-swatch" style="background-color: #ff00ff;" data-color="#ff00ff"></div>
                    <div class="color-swatch" style="background-color: #00ffff;" data-color="#00ffff"></div>
                    <div class="color-swatch" style="background-color: #ffffff; border: 1px solid #ccc;" data-color="#ffffff"></div>
                </div>
                <div class="color-picker-container">
                    <input type="color" class="color-picker" id="colorPicker" value="#000000" title="More Colors">
                </div>
            </div>

            <div class="tool-group">
                <div class="tool-group-title">Size</div>
                <div class="size-selector-container">
                    <input type="range" class="size-selector" id="sizeSelector" min="1" max="50" value="5">
                    <div class="tool-name" id="sizeValue">5px</div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="top-toolbar">
                <button class="top-tool-btn" id="saveTool" title="Save (Ctrl+S)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTE1LDlINVY1SDE5VjlNMTYsMTdWMTlIOFYxN0gxNk0xMCwxM1YxNUg4VjEzSDEwbTMsMFYxNUgxMVYxM0gxM20zLDBWMTVIMTRWMTNIMTZNMTksM0g1QzMuODksMyAzLDMuOSAzLDVWMTlDMywyMC4xIDMuOSwyMSA1LDIxSDE5QzIwLjEsMjEgMjEsMjAuMSAyMSwxOVY1QzIxLDMuOSAyMC4xLDMgMTksM00xOSwxOUgxMVYxMUg5VjE5SDVWNUg5VjlIMTlWMTkiIC8+PC9zdmc+" class="tool-icon">
                    Save
                </button>
                <button class="top-tool-btn" id="clearTool" title="Clear (Del)">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzAwMDAwMCIgZD0iTTE5LDRIMTUuNUwxNC41LDNIOS41TDguNSw0SDVWNkgxOU02LDE5QTIsMiAwIDAsMCA4LDIxSDE2QTIsMiAwIDAsMCAxOCwxOVY3SDZWNjlaIiAvPjwvc3ZnPg==" class="tool-icon">
                    Clear
                </button>
                
                <div class="shape-options" id="shapeOptions">
                    <div class="shape-option">
                        <label for="fillShape">Fill:</label>
                        <input type="checkbox" id="fillShape">
                    </div>
                    <div class="shape-option">
                        <label for="lineStyle">Style:</label>
                        <select class="shape-select" id="lineStyle">
                            <option value="solid">Solid</option>
                            <option value="dashed">Dashed</option>
                            <option value="dotted">Dotted</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="canvas-container">
                <canvas id="paintCanvas" width="800" height="600"></canvas>
            </div>

            <div class="status-bar">
                <div id="cursorPos">X: 0, Y: 0</div>
                <div id="toolInfo">Tool: Pencil | Size: 5px | Color: #000000</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('paintCanvas');
            const ctx = canvas.getContext('2d');
            const colorPicker = document.getElementById('colorPicker');
            const sizeSelector = document.getElementById('sizeSelector');
            const sizeValue = document.getElementById('sizeValue');
            const cursorPos = document.getElementById('cursorPos');
            const toolInfo = document.getElementById('toolInfo');
            const fillShape = document.getElementById('fillShape');
            const lineStyle = document.getElementById('lineStyle');
            const shapeOptions = document.getElementById('shapeOptions');
            
            // Tool buttons
            const pencilTool = document.getElementById('pencilTool');
            const brushTool = document.getElementById('brushTool');
            const eraserTool = document.getElementById('eraserTool');
            const lineTool = document.getElementById('lineTool');
            const rectTool = document.getElementById('rectTool');
            const circleTool = document.getElementById('circleTool');
            const triangleTool = document.getElementById('triangleTool');
            const polygonTool = document.getElementById('polygonTool');
            const fillTool = document.getElementById('fillTool');
            const clearTool = document.getElementById('clearTool');
            const saveTool = document.getElementById('saveTool');
            
            // Color swatches
            const colorSwatches = document.querySelectorAll('.color-swatch');
            
            // Drawing state
            let isDrawing = false;
            let currentTool = 'pencil';
            let startX, startY;
            let snapshot;
            let polygonPoints = [];
            let isDrawingPolygon = false;
            
            // Set canvas background to white
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Event listeners for tool selection
            pencilTool.addEventListener('click', () => setActiveTool('pencil'));
            brushTool.addEventListener('click', () => setActiveTool('brush'));
            eraserTool.addEventListener('click', () => setActiveTool('eraser'));
            lineTool.addEventListener('click', () => setActiveTool('line'));
            rectTool.addEventListener('click', () => setActiveTool('rect'));
            circleTool.addEventListener('click', () => setActiveTool('circle'));
            triangleTool.addEventListener('click', () => setActiveTool('triangle'));
            polygonTool.addEventListener('click', () => setActiveTool('polygon'));
            fillTool.addEventListener('click', () => setActiveTool('fill'));
            clearTool.addEventListener('click', clearCanvas);
            saveTool.addEventListener('click', saveCanvas);
            
            // Color swatches
            colorSwatches.forEach(swatch => {
                swatch.addEventListener('click', function() {
                    colorSwatches.forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    colorPicker.value = this.getAttribute('data-color');
                    updateToolInfo();
                });
            });
            
            // Color picker
            colorPicker.addEventListener('input', updateToolInfo);
            
            // Size selector
            sizeSelector.addEventListener('input', function() {
                sizeValue.textContent = this.value + 'px';
                updateToolInfo();
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveCanvas();
                }
                
                switch(e.key.toLowerCase()) {
                    case 'p': setActiveTool('pencil'); break;
                    case 'b': setActiveTool('brush'); break;
                    case 'e': setActiveTool('eraser'); break;
                    case 'l': setActiveTool('line'); break;
                    case 'r': setActiveTool('rect'); break;
                    case 'c': setActiveTool('circle'); break;
                    case 't': setActiveTool('triangle'); break;
                    case 'y': setActiveTool('polygon'); break;
                    case 'f': setActiveTool('fill'); break;
                    case 'delete': clearCanvas(); break;
                    case 'escape': 
                        if (currentTool === 'polygon' && isDrawingPolygon) {
                            cancelPolygon();
                        }
                        break;
                    case 'enter':
                        if (currentTool === 'polygon' && isDrawingPolygon && polygonPoints.length >= 3) {
                            completePolygon();
                        }
                        break;
                }
            });
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', drawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('mousemove', updateCursorPosition);
            canvas.addEventListener('dblclick', handleDoubleClick);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(
                    e.type === 'touchstart' ? 'mousedown' : 'mousemove', 
                    {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    }
                );
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleDoubleClick(e) {
                if (currentTool === 'polygon' && isDrawingPolygon && polygonPoints.length >= 3) {
                    completePolygon();
                }
            }
            
            function setActiveTool(tool) {
                currentTool = tool;
                
                // Update active button
                const tools = [pencilTool, brushTool, eraserTool, lineTool, rectTool, circleTool, triangleTool, polygonTool, fillTool];
                tools.forEach(t => t.classList.remove('active'));
                
                switch(tool) {
                    case 'pencil': pencilTool.classList.add('active'); break;
                    case 'brush': brushTool.classList.add('active'); break;
                    case 'eraser': eraserTool.classList.add('active'); break;
                    case 'line': lineTool.classList.add('active'); break;
                    case 'rect': rectTool.classList.add('active'); break;
                    case 'circle': circleTool.classList.add('active'); break;
                    case 'triangle': triangleTool.classList.add('active'); break;
                    case 'polygon': polygonTool.classList.add('active'); break;
                    case 'fill': fillTool.classList.add('active'); break;
                }
                
                // Show/hide shape options
                if (['line', 'rect', 'circle', 'triangle', 'polygon'].includes(tool)) {
                    shapeOptions.style.display = 'flex';
                } else {
                    shapeOptions.style.display = 'none';
                }
                
                // Reset polygon drawing state if switching tools
                if (tool !== 'polygon') {
                    isDrawingPolygon = false;
                    polygonPoints = [];
                }
                
                // Update cursor
                canvas.style.cursor = (tool === 'fill') ? 'crosshair' : 'crosshair';
                
                updateToolInfo();
            }
            
            function startDrawing(e) {
                isDrawing = true;
                startX = e.offsetX;
                startY = e.offsetY;
                
                if (currentTool === 'polygon') {
                    if (!isDrawingPolygon) {
                        // Start a new polygon
                        isDrawingPolygon = true;
                        polygonPoints = [{x: startX, y: startY}];
                        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    } else {
                        // Add a point to the current polygon
                        polygonPoints.push({x: startX, y: startY});
                    }
                } else if (currentTool !== 'pencil' && currentTool !== 'brush' && currentTool !== 'eraser') {
                    // Save the canvas state for shapes
                    snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }
                
                if (currentTool === 'fill') {
                    floodFill(e.offsetX, e.offsetY, hexToRgb(colorPicker.value));
                    isDrawing = false;
                }
                
                ctx.beginPath();
            }
            
            function drawing(e) {
                if (!isDrawing) return;
                
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Set line style
                if (lineStyle.value === 'dashed') {
                    ctx.setLineDash([5, 5]);
                } else if (lineStyle.value === 'dotted') {
                    ctx.setLineDash([2, 5]);
                } else {
                    ctx.setLineDash([]);
                }
                
                if (currentTool === 'pencil' || currentTool === 'brush' || currentTool === 'eraser') {
                    // Free drawing tools
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.strokeStyle = currentTool === 'eraser' ? 'white' : colorPicker.value;
                    ctx.lineWidth = currentTool === 'brush' ? sizeSelector.value * 2 : sizeSelector.value;
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(e.offsetX, e.offsetY);
                } else if (currentTool === 'polygon' && isDrawingPolygon) {
                    // For polygon, show preview of current line
                    ctx.putImageData(snapshot, 0, 0);
                    drawPolygonPreview(e.offsetX, e.offsetY);
                } else {
                    // Shape tools - restore snapshot and redraw
                    ctx.putImageData(snapshot, 0, 0);
                    
                    ctx.strokeStyle = colorPicker.value;
                    ctx.fillStyle = colorPicker.value;
                    ctx.lineWidth = sizeSelector.value;
                    
                    const width = e.offsetX - startX;
                    const height = e.offsetY - startY;
                    
                    switch(currentTool) {
                        case 'line':
                            ctx.beginPath();
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(e.offsetX, e.offsetY);
                            ctx.stroke();
                            break;
                        case 'rect':
                            ctx.beginPath();
                            ctx.rect(startX, startY, width, height);
                            if (fillShape.checked) {
                                ctx.fill();
                            } else {
                                ctx.stroke();
                            }
                            break;
                        case 'circle':
                            ctx.beginPath();
                            const radius = Math.sqrt(width * width + height * height);
                            ctx.arc(startX, startY, radius, 0, Math.PI * 2);
                            if (fillShape.checked) {
                                ctx.fill();
                            } else {
                                ctx.stroke();
                            }
                            break;
                        case 'triangle':
                            drawTriangle(startX, startY, e.offsetX, e.offsetY);
                            break;
                    }
                }
            }
            
            function stopDrawing() {
                isDrawing = false;
                
                // For filled shapes (except polygon which is handled separately)
                if (['rect', 'circle', 'triangle'].includes(currentTool) && fillShape.checked) {
                    // Already filled in drawing function
                }
            }
            
            function drawTriangle(x1, y1, x2, y2) {
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.lineTo(x1 * 2 - x2, y2);
                ctx.closePath();
                
                if (fillShape.checked) {
                    ctx.fill();
                } else {
                    ctx.stroke();
                }
            }
            
            function drawPolygonPreview(currentX, currentY) {
                ctx.strokeStyle = colorPicker.value;
                ctx.fillStyle = colorPicker.value;
                ctx.lineWidth = sizeSelector.value;
                
                // Draw the polygon so far
                ctx.beginPath();
                ctx.moveTo(polygonPoints[0].x, polygonPoints[0].y);
                
                for (let i = 1; i < polygonPoints.length; i++) {
                    ctx.lineTo(polygonPoints[i].x, polygonPoints[i].y);
                }
                
                // Draw the current line to cursor
                ctx.lineTo(currentX, currentY);
                
                // Close the polygon for preview
                ctx.closePath();
                
                if (fillShape.checked) {
                    ctx.fill();
                } else {
                    ctx.stroke();
                }
            }
            
            function completePolygon() {
                if (polygonPoints.length < 3) return;
                
                ctx.strokeStyle = colorPicker.value;
                ctx.fillStyle = colorPicker.value;
                ctx.lineWidth = sizeSelector.value;
                
                ctx.beginPath();
                ctx.moveTo(polygonPoints[0].x, polygonPoints[0].y);
                
                for (let i = 1; i < polygonPoints.length; i++) {
                    ctx.lineTo(polygonPoints[i].x, polygonPoints[i].y);
                }
                
                ctx.closePath();
                
                if (fillShape.checked) {
                    ctx.fill();
                } else {
                    ctx.stroke();
                }
                
                // Reset polygon state
                isDrawingPolygon = false;
                polygonPoints = [];
            }
            
            function cancelPolygon() {
                // Restore the snapshot to remove the polygon preview
                ctx.putImageData(snapshot, 0, 0);
                isDrawingPolygon = false;
                polygonPoints = [];
            }
            
            function clearCanvas() {
                if (confirm('Are you sure you want to clear the canvas?')) {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            }
            
            function saveCanvas() {
                const link = document.createElement('a');
                link.download = 'drawing.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
            
            function updateCursorPosition(e) {
                cursorPos.textContent = `X: ${e.offsetX}, Y: ${e.offsetY}`;
            }
            
            function updateToolInfo() {
                const color = colorPicker.value;
                const size = sizeSelector.value;
                toolInfo.textContent = `Tool: ${currentTool.charAt(0).toUpperCase() + currentTool.slice(1)} | Size: ${size}px | Color: ${color}`;
            }
            
            // Flood fill algorithm
            function floodFill(x, y, fillColor) {
                // Get canvas data
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // Get the color at the clicked position
                const targetPos = (y * canvas.width + x) * 4;
                const targetColor = {
                    r: data[targetPos],
                    g: data[targetPos + 1],
                    b: data[targetPos + 2],
                    a: data[targetPos + 3]
                };
                
                // Don't fill if the target color matches the fill color
                if (targetColor.r === fillColor.r && 
                    targetColor.g === fillColor.g && 
                    targetColor.b === fillColor.b) {
                    return;
                }
                
                // Stack-based flood fill
                const stack = [{x, y}];
                const width = canvas.width;
                
                while (stack.length) {
                    const {x, y} = stack.pop();
                    const pos = (y * width + x) * 4;
                    
                    // Check boundaries and color match
                    if (x < 0 || x >= width || y < 0 || y >= canvas.height) continue;
                    if (data[pos] !== targetColor.r || 
                        data[pos + 1] !== targetColor.g || 
                        data[pos + 2] !== targetColor.b || 
                        data[pos + 3] !== targetColor.a) continue;
                    
                    // Fill the pixel
                    data[pos] = fillColor.r;
                    data[pos + 1] = fillColor.g;
                    data[pos + 2] = fillColor.b;
                    data[pos + 3] = 255;
                    
                    // Add neighboring pixels to stack
                    stack.push({x: x + 1, y});
                    stack.push({x: x - 1, y});
                    stack.push({x, y: y + 1});
                    stack.push({x, y: y - 1});
                }
                
                // Put the modified data back to canvas
                ctx.putImageData(imageData, 0, 0);
            }
            
            // Helper function to convert hex to RGB
            function hexToRgb(hex) {
                const r = parseInt(hex.substring(1, 3), 16);
                const g = parseInt(hex.substring(3, 5), 16);
                const b = parseInt(hex.substring(5, 7), 16);
                return {r, g, b};
            }
            
            // Initialize with pencil tool
            setActiveTool('pencil');
        });
    </script>
</body>
</html>
